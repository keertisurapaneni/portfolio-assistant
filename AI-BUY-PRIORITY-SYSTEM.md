# AI Trade Signal System

## Overview

The Portfolio Assistant uses **AI-powered trade signals** to help you decide what to do with each stock you own. Signals are generated by Groq's Llama 3.3 70B model (with Qwen3 32B fallback), routed securely through a Supabase Edge Function.

**Key principle:** AI is the single source of truth. There are no rule-based overrides. Every signal you see comes from the same AI analysis.

---

## Signal Types

### BUY (Green)

**When:** Quality stock with a meaningful dip and no bad company news
**Action:** Deploy capital — this is an opportunity

**Typical triggers:**

- Stock down 3%+ today with avg score 65+ and no negative company news
- Stock 15%+ below 52-week high with strong fundamentals and analyst upside
- Quality stock (Q:70+ E:65+) with a significant dip

### SELL (Red)

**When:** Stock has fundamental problems, hit stop-loss, or needs trimming
**Action:** Reduce or exit position

**Typical triggers:**

- Weak fundamentals (avg score <50) + stock declining + negative margins
- Stop-loss triggered (down 7-8% from purchase price, risk-profile adjusted)
- Profit-taking zone (up 20-25% from purchase)
- Overconcentrated position (>20-30% of portfolio, risk-profile adjusted)
- Earnings miss with deteriorating business

### No Signal (null)

**When:** No action needed today
**Meaning:** Quality stock on a flat day, or nothing meaningful has changed

---

## How It Works

### 1. Trigger Detection (Client-Side)

Before calling the AI, the system checks if there's a reason to analyze:

- Significant daily price move (2.5%+)
- Stop-loss or profit-take zone
- Overconcentrated position
- Near 52-week extremes with quality scores
- Earnings/news catalysts

**No triggers = no AI call.** This saves tokens and keeps costs within free tier.

### 2. Mechanical Guardrails

Before the AI call, hard SELL signals fire for:

- Stop-loss breach (risk-profile adjusted: -4% aggressive, -7% moderate, -5% conservative)
- Profit-taking zone (risk-profile adjusted: +25% aggressive, +20% moderate/conservative)
- Overconcentration (risk-profile adjusted: >30% aggressive, >25% moderate, >20% conservative)
- Weak fundamentals + weak momentum (avg <35, momentum <35)

These match across main card and detail view — no discrepancies.

### 3. AI Analysis (Server-Side)

For stocks that pass trigger detection:

- Sent to Groq's Llama 3.3 70B via Supabase Edge Function
- If 70B is rate-limited, falls back to Qwen3 32B
- If both are rate-limited, retries after 3s delay
- Client retries failed stocks after 10s cooldown

### 4. Caching

- Each AI result is cached for 4 hours per stock
- Cache is keyed by prompt version — any prompt change invalidates all cache
- Cached results return instantly (no API call needed)

---

## Risk Profiles

Risk profiles adjust the mechanical guardrails:

| Setting          | Stop-Loss | Profit-Take | Max Position |
| ---------------- | --------- | ----------- | ------------ |
| **Aggressive**   | -4%       | +25%        | 30%          |
| **Moderate**     | -7%       | +20%        | 25%          |
| **Conservative** | -5%       | +20%        | 20%          |

Change your risk profile in Settings (gear icon).

---

## AI Architecture

### Two-Model Pipeline

1. **Primary:** `llama-3.3-70b-versatile` — Best reasoning, best for nuanced decisions
2. **Fallback:** `qwen/qwen3-32b` — Higher rate limits, good quality

### Rate Limiting

- 4-second delay between API calls
- Server-side retry if both models 429
- Client-side retry pass for any failed stocks
- 15-second cooldown on 429 errors

### System Prompt

The AI acts as an "elite stock analyst" with:

- Explicit BUY conditions (quality + dip + no bad news)
- Explicit SELL conditions (weak fundamentals + declining, stop-loss, profit-take)
- Few-shot examples for BUY, SELL, and null
- Context that the user OWNS these stocks (not screening)

---

## Data Completeness

### Full Data (Best Signals)

**Requires:** Shares + average cost + current market data

**What you get:**

- Position-aware recommendations
- Stop-loss and profit-taking signals
- Concentration risk detection
- Portfolio weight in AI reasoning

### Scores Only (Limited Signals)

**When:** Missing shares or average cost

**What you get:**

- Score-based BUY/SELL decisions
- No stop-loss or profit-take (needs cost basis)
- Badge shows asterisk (\*)

---

## What Shows Where

### Main Card

- **BUY/SELL badge** — from AI analysis
- **Card note** — 5-8 word AI summary (e.g., "Fear dip on quality, buy")
- Only appears after AI analysis runs (hit refresh)

### Detail View (Click Card)

- **AI Trade Signal section** — full reasoning (2-3 sentences)
- **Liquidity risk** — for low-volume stocks
- Same AI result as main card — always in sync

---

## Getting Better Signals

### Import Your Portfolio

1. Click **Add Stocks** → Import Portfolio tab
2. Upload CSV/Excel with: Ticker, Shares, Average Cost
3. Hit refresh to run AI analysis

### Why Position Data Matters

- **Shares** → enables portfolio weight calculation → concentration alerts
- **Average Cost** → enables stop-loss and profit-taking signals
- Without these, AI can only judge based on scores and price action

### Example CSV

```csv
Ticker,Shares,Average Cost
META,500,280.50
SNOW,1000,150.25
GOOGL,300,140.75
```

---

## FAQ

**Q: Why are there no signals on page load?**
A: AI signals only appear after you hit refresh. This avoids stale cached results and ensures fresh analysis.

**Q: Why did a stock get no signal (null)?**
A: The AI found no actionable trigger — quality stock on a flat day, or weak stock not declining enough to warrant SELL.

**Q: Why is RBRK showing SELL?**
A: Weak fundamentals (avg score <50) + declining price + negative margins. The AI correctly identifies this as "cut the loser."

**Q: Can I change how aggressive the signals are?**
A: Yes — change your risk profile in Settings. Aggressive = tighter stop-loss (-4%), Conservative = more room (-5%).

**Q: How many AI calls does a refresh make?**
A: One per stock that has a trigger. Stocks with no triggers (flat day, no news) skip the AI call entirely.
